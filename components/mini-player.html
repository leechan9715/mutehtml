<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미니플레이어</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="../../css/base/variables.css" />
    <link rel="stylesheet" href="../../css/base/reset.css" />
    <link rel="stylesheet" href="../..//assets/fonts/fonts.css" />
    <link rel="stylesheet" href="../..//css/layout/grid.css" />
    <link rel="stylesheet" href="../css/components/mini-player.css">
</head>

<body>
    <div id="wrap">
        <h3 class="hidden">미니 플레이어</h3>
        <div class="container mini-bar">
            <div class="mini-progress-bar">
                <div class="mini-progress-fill"></div>
            </div>
        </div>
        <div class="container mini-player">
            <div class="song-info">
                <p class="song-name ">혜성</p>
                <p class="singer-name">윤하(YOUNHA)</p>
            </div>
            <div class="icons">
                <button class="cast-button">
                    <img src="../assets/images/player/cast.png" alt="cast-button">
                </button>
                <button class="play-pause-button">
                    <img src="../../assets/images/player/play.png" alt="play-button" class="play-pause-img" />
                </button>
            </div>
        </div>
    </div>

</body>

<script>
    // ========================================
    // 설정
    // ========================================
    const totalDuration = 217; // 총 재생 시간 (초)
    let currentTime = 0;
    let isPlaying = false;
    let isDragging = false;
    let animationFrameId = null;

    // ========================================
    // DOM 요소
    // ========================================
    const miniProgressBar = document.querySelector(".mini-progress-bar");
    const miniProgressFill = document.querySelector(".mini-progress-fill");
    const playPauseButton = document.querySelector(".play-pause-button");
    const playPauseImg = document.querySelector(".play-pause-img");

    // ========================================
    // 진행바 업데이트
    // ========================================
    function updateProgress() {
        const percentage = (currentTime / totalDuration) * 100;
        const clampedPercentage = Math.max(0, Math.min(100, percentage));
        miniProgressFill.style.width = clampedPercentage + "%";
    }

    // ========================================
    // 자동 재생
    // ========================================
    let lastTime = Date.now();

    function playMusic() {
        if (isPlaying && !isDragging) {
            const now = Date.now();
            const delta = (now - lastTime) / 1000;
            lastTime = now;

            currentTime += delta;

            if (currentTime >= totalDuration) {
                currentTime = totalDuration;
                isPlaying = false;
                playPauseImg.src = "../../assets/images/player/play.png";
                playPauseImg.alt = "play-button";
                cancelAnimationFrame(animationFrameId);
                return;
            }

            updateProgress();
        }

        if (isPlaying) {
            animationFrameId = requestAnimationFrame(playMusic);
        }
    }

    // ========================================
    // 재생/일시정지
    // ========================================
    playPauseButton.addEventListener("click", () => {
        isPlaying = !isPlaying;

        if (isPlaying) {
            playPauseImg.src = "../../assets/images/player/pause.png";
            playPauseImg.alt = "pause-button";
            lastTime = Date.now();
            animationFrameId = requestAnimationFrame(playMusic);
        } else {
            playPauseImg.src = "../../assets/images/player/play.png";
            playPauseImg.alt = "play-button";
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }

        if (currentTime >= totalDuration) {
            currentTime = 0;
        }
    });

    // ========================================
    // 진행바 클릭/드래그
    // ========================================
    let rafId = null;

    miniProgressBar.addEventListener("mousedown", (e) => {
        isDragging = true;
        miniProgressBar.classList.add("dragging");
        updateTimeFromClick(e);
    });

    window.addEventListener("mousemove", (e) => {
        if (isDragging) {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
                updateTimeFromClick(e);
            });
        }
    });

    window.addEventListener("mouseup", () => {
        if (isDragging) {
            isDragging = false;
            miniProgressBar.classList.remove("dragging");
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
        }
    });

    // ✅ 터치 이벤트
    miniProgressBar.addEventListener("touchstart", (e) => {
        isDragging = true;
        miniProgressBar.classList.add("dragging");
        updateTimeFromTouch(e);
    });

    window.addEventListener(
        "touchmove",
        (e) => {
            if (isDragging) {
                e.preventDefault();
                if (rafId) cancelAnimationFrame(rafId);
                rafId = requestAnimationFrame(() => {
                    updateTimeFromTouch(e);
                });
            }
        },
        { passive: false }
    );

    window.addEventListener("touchend", () => {
        if (isDragging) {
            isDragging = false;
            miniProgressBar.classList.remove("dragging");
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
        }
    });

    function updateTimeFromClick(e) {
        const rect = miniProgressBar.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const percentage = Math.max(0, Math.min(1, clickX / rect.width));
        currentTime = percentage * totalDuration;
        updateProgress();
    }

    function updateTimeFromTouch(e) {
        const rect = miniProgressBar.getBoundingClientRect();
        const touch = e.touches[0];
        const touchX = touch.clientX - rect.left;
        const percentage = Math.max(0, Math.min(1, touchX / rect.width));
        currentTime = percentage * totalDuration;
        updateProgress();
    }

    // ========================================
    // 초기 설정
    // ========================================
    updateProgress();

</script>

</html>